# Status List Publisher Module Documentation

## Why This Service Exists
- Publishes and maintains W3C StatusList2021 documents that track revocation/suspension state for Verifiable Credentials issued by the platform.
- Signs Status List Verifiable Credentials (VCs) with a configured issuer key so external verifiers can consume an authenticated status list.
- Exposes a concise HTTP API for bootstrapping a list, toggling individual credential slots, and retrieving both the raw status list document and its signed VC representation.
- Serves the generated artefacts from a static-friendly `public/` directory so you can host them behind any CDN or web server while still updating them through this service.

## High-Level Flow
1. **Configuration** is loaded from environment variables (or files) in `src/config.ts`. This step validates you provided a signing key and other required metadata.
2. **Fastify Server** spins up in `src/server.ts`, wiring static hosting (for `/public/*`) and the dynamic status routes defined in `src/routes/status.ts`.
3. **Status List Creation** (`POST /status/init`) builds a zeroed bitmap, wraps it in the `StatusListDocument` schema, hashes it, and persists it under `public/statuslists/<listId>.json`.
4. **Status Updates** (`POST /status/update`) flip individual bits in the bitmap, recompute version/hash metadata, and overwrite the stored document.
5. **VC Materialisation** (`GET /status/:listId/vc`) turns the stored document into a StatusList2021 VC, signs it using `core/signer.ts`, saves the signed payload to `public/vc/<listId>.json`, and returns it to the caller.
6. **Static Serving** allows both the mutable JSON documents and the signed VC files to be served via Fastify’s static plugin or any external static host pointing at the `public/` directory.

## Environment & Deployment Expectations
- Provide `.env` values for `BASE_URL`, `ISSUER_DID`, `SIGNING_KID`, and either `SIGNING_JWK` or `SIGNING_JWK_FILE`. Missing or malformed configuration stops startup with a clear error.
- `BASE_URL` should match the public URL that exposes the contents of `public/`, so the generated `id` fields resolve for consumers.
- The service is designed to run behind a reverse proxy/CDN; only the `/status/*` endpoints need to be reachable for administrative workflows.

## Code and Asset Inventory

### `.env`
- Developer-provided environment file (not committed) where you define runtime configuration. See the configuration expectations above.

### `package.json`
- Declares the service as a Node ESM package, with Fastify, Zod, `jose`, and `blakejs` as runtime dependencies.
- Scripts:
  - `npm run dev`: start the server with `ts-node/esm` for on-the-fly TypeScript execution.
  - `npm run build`: compile TypeScript to ESM output under `dist/`.
- Lockfile support via `package-lock.json` ensures repeatable installs.

### `tsconfig.json`
- TypeScript compiler configuration targeting Node 18+ ESM output, aligning source resolution for both `ts-node` and `tsc`.

### `dist/`
- Build artefacts generated by `npm run build`. Not edited manually; mirrors the structure of `src/` in compiled JavaScript form.

### `node_modules/`
- Installed dependencies. Omitted from documentation beyond noting that Fastify, Zod, `jose`, and `blakejs` power the service.

### `public/`
- Static web root served by Fastify. Intended to be backed by a CDN or object store in production.
- `public/statuslists/`: stores status list documents (JSON). Ship includes `.gitkeep` to track the empty directory.
- `public/vc/`: stores signed VC payloads mirroring the documents. Also tracked with `.gitkeep`.

### `shared/src/lib/hash.ts`
- Lightweight wrapper around `blakejs` to expose `blake2b256Hex` and `blake2b256Bytes32` helpers.
- `computeHash` in `core/statuslist.ts` uses `blake2b256Hex` to derive list hashes.

### `src/server.ts`
- Entrypoint for the service. Creates a Fastify instance, registers static file serving, mounts the status routes, and listens on `cfg.port` on all interfaces.
- Logs a startup banner once listening succeeds.

### `src/config.ts`
- Loads `.env` variables via `dotenv`. The helper `requireEnv` enforces non-empty required values.
- Accepts the signing JWK either inline (`SIGNING_JWK`) or via file (`SIGNING_JWK_FILE`) and parses it, emitting descriptive errors if invalid.
- Exposes the `cfg` object consumed across the service (port, base URL, issuer DID, signing key metadata, list defaults).

### `src/routes/status.ts`
- Registers all HTTP endpoints under `/status/*`.
- `GET /status/:listId`: retrieves the stored `StatusListDocument` from disk.
- `GET /status/:listId/vc`: reads the document, constructs a W3C StatusList VC (`makeStatusListVC`), signs it (`signVC`), persists the signed payload, and returns it.
- `POST /status/init`: idempotently creates a new status list with a zeroed bitmap, defaulting values from `cfg`. Persists the document and returns `201 Created`.
- `POST /status/update`: toggles a bit position within an existing list (flip on/off), updates timestamps/version/hash, and persists the mutation.
- Uses Zod to validate bodies, `FSStorage` for persistence, and `Bitset` for bit-level operations.

### `src/core/bitset.ts`
- Implements a fixed-size bitmap abstraction using `Uint8Array` storage.
- Supports `set`, `get`, `toBase64`, and `fromBase64`, enabling compact transport/storage of revocation state.

### `src/core/storage.ts`
- Filesystem-backed JSON persistence that scopes all reads/writes to a base directory (`public/`).
- Ensures directories are created before writing and returns parsed JSON when reading.

### `src/core/statuslist.ts`
- Contains helpers tied to the StatusList2021 data model.
- `computeHash`: deterministic Blake2b-256 hash over document fields (excluding the existing hash).
- `computeHashBytes32`: variant that returns a `0x`-prefixed 32-byte hex string (useful for on-chain integrations).
- `makeStatusListVC`: converts a stored document into the W3C StatusList2021 credential structure with the appropriate contexts and credentialSubject.

### `src/core/signer.ts`
- Wraps `jose` helpers to sign Status List VCs as JWTs.
- Imports the configured JWK (supporting Ed25519 and P-256) and returns the `JsonWebSignature2020`-compatible `proof` object containing the JWS string.

### `src/types.ts`
- TypeScript contracts for `StatusListDocument`, `StatusListCredential`, and the `StatusPurpose` union. Used throughout the module for type safety and clarity.

### `shared/`
- Host for code shared with other services in the monorepo. Currently only the hashing helper is referenced by this service.

### Generated JSON Artefacts (example)
- Files like `public/statuslists/main-2025-01.json` illustrate the structure produced by `/status/init`; they are environment-specific and not part of source control.

## Operational Steps
1. **Prepare configuration**: Generate/import a private JWK, populate `.env`, and optionally point `SIGNING_JWK_FILE` to a secrets-managed path.
2. **Start the service**: `npm install` (first run) followed by `npm run dev` for development or `npm run build && node dist/server.js` for production.
3. **Create a status list**: POST to `/status/init` with a desired `listId`, optional size, and status purpose.
4. **Update entries**: Use `/status/update` to flip bits representing credential revocation/suspension status.
5. **Distribute artefacts**: Serve `public/statuslists` and `public/vc` outputs to verifiers; automate refresh as part of your issuance pipeline.

## Extensibility Notes
- Additional storage backends can replace `FSStorage` if you implement the same interface (e.g., S3, database).
- Support for multiple issuer keys could be added by extending configuration and the signer helper.
- To expose metrics or authentication, wrap Fastify’s hooks/middleware around the existing routes.

